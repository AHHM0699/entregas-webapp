<script>
/* ================= CONFIG ================= */
const API = "http://127.0.0.1:5000"; // CAMBIAR por IP de la PC en LAN

/* ================= NAVEGACIÓN ================= */
function mostrar(id, btn) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  if (id === "despachos") cargarDespachos();
}

/* ================= REGISTRO ================= */
async function registrar() {
  if (!celular.value || !nombre.value) {
    alert("Celular y nombre son obligatorios");
    return;
  }

  const payload = {
    celular: celular.value,
    nombre: nombre.value,
    ciudad: ciudad.value,
    direccion: direccion.value,
    referencia: referencia.value,
    productos: productos.value,
    observaciones: obs.value
  };

  try {
    const r = await fetch(`${API}/registrar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await r.json();

    if (!data.ok) {
      alert(data.error || "Error al registrar");
      return;
    }

    msg.innerHTML = `
      <div class="ok">
        ✅ PEDIDO REGISTRADO<br>
        ID DE COMPRA: ${data.entrega_id}
      </div>
    `;

    celular.value = nombre.value = ciudad.value =
    direccion.value = referencia.value =
    productos.value = obs.value = "";

  } catch (e) {
    alert("No se pudo conectar al backend");
  }
}

/* ================= DESPACHOS ================= */
async function cargarDespachos() {
  try {
    const r = await fetch(`${API}/despachos/pendientes`);
    const data = await r.json();
    render(data);
  } catch (e) {
    alert("Error cargando despachos");
  }
}

/* ================= RENDER TABLA ================= */
function render(pedidos) {
  tabla.innerHTML = "";
  const filtro = filtroEstado.value;

  pedidos
    .filter(p => filtro === "TODOS" || p.estado === filtro)
    .forEach(p => {
      tabla.innerHTML += `
      <tr>
        <td>${p.cliente ?? ""}</td>
        <td>${p.ciudad}</td>
        <td>${p.celular}</td>
        <td>${p.productos}</td>
        <td>${p.fecha}</td>
        <td class="estado-pendiente">${p.estado}</td>
        <td>${p.repartidor ?? ""}</td>
        <td>
          <button onclick="despachar(${p.entrega_id})">
            DESPACHAR
          </button>
        </td>
      </tr>`;
    });
}

/* ================= DESPACHAR (placeholder) ================= */
function despachar(id) {
  alert("Siguiente paso: despachar ID " + id);
}
</script>
